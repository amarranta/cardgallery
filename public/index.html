<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Card Gallery</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="icon" type="image/svg+xml" href="assets/img/amarantha-logo.svg">
  <style>
    :root {
      --deep-olive: #435339;
      --sage: #9eb589;
      --linen: #ede4d2;
      --sand: #cdbb99;
      --bg: var(--linen);
      --card-bg: #fbf5e8;
      --accent: #314427;
      --accent-light: rgba(67, 83, 57, 0.16);
      --text: #21311d;
      --muted: #6f7762;
      --border: rgba(67, 83, 57, 0.28);
      --border-strong: rgba(67, 83, 57, 0.42);
      --radius-lg: 8px;
      --radius-md: 6px;
      --radius-sm: 4px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: inherit; }

    #app {
      display: flex;
      min-height: 100vh;
    }

    #sidebar {
      width: 260px;
      background: #f5ecda;
      border-right: 1px solid var(--border);
      padding: 24px 20px 28px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      overflow-y: auto;
    }

    .sidebar-profile {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 6px;
    }

    .sidebar-profile img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 8px 16px rgba(33, 49, 29, 0.2);
    }

    .sidebar-name {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-name strong {
      font-size: 1.15rem;
      color: var(--accent);
      letter-spacing: 0.02em;
    }

    .sidebar-name span {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .sidebar-subtitle {
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    #tagList {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .album-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .album-link {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 600;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .album-link:hover {
      background: rgba(67, 83, 57, 0.16);
    }

    .album-link.active {
      background: rgba(67, 83, 57, 0.22);
      color: var(--accent);
    }

    .album-link .label {
      flex: 1;
    }

    .album-link.root {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--accent);
    }

    .tag-filter {
      appearance: none;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 500;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      text-align: left;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
    }

    .tag-filter:hover {
      background: rgba(67, 83, 57, 0.16);
    }

    .tag-filter.active {
      background: rgba(67, 83, 57, 0.2);
      border-color: rgba(67, 83, 57, 0.45);
      color: var(--accent);
      font-weight: 600;
    }

    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .profile-hero {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 28px 36px 20px;
      background: linear-gradient(135deg, rgba(67, 83, 57, 0.08) 0%, rgba(205, 187, 153, 0.2) 100%);
      border-bottom: 1px solid rgba(67, 83, 57, 0.18);
    }

    .profile-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid rgba(67, 83, 57, 0.35);
      box-shadow: 0 10px 24px rgba(33, 49, 29, 0.2);
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .profile-copy h1 {
      margin: 0;
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--accent);
    }

    .profile-copy p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }

    #contentHeader {
      padding: 32px 36px 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      border-bottom: 1px solid rgba(67, 83, 57, 0.2);
      background: linear-gradient(180deg, rgba(255,255,255,0.96) 0%, rgba(251,245,232,0.78) 100%);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
      font-weight: 600;
      font-size: 0.95rem;
      text-decoration: none;
      width: fit-content;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .back-link::before {
      content: '‚Üê';
      font-size: 1rem;
    }

    .back-link.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .back-link:hover {
      transform: translateX(-2px);
    }

    #contentHeader h2 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
    }

    #contentHeader p {
      margin: 4px 0 0;
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .button-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(67, 83, 57, 0.32);
      background: rgba(252, 244, 229, 0.85);
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .button-link:hover {
      background: rgba(67, 83, 57, 0.18);
      transform: translateY(-1px);
    }

    .album-grid {
      flex: 1;
      overflow-y: auto;
      padding: 24px 36px 32px;
      display: grid;
      gap: 16px;
      align-items: start;
    }

    .album-grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    .image-grid {
      flex: 1;
      overflow-y: auto;
      padding: 24px 36px 32px;
      column-width: 220px;
      column-gap: 14px;
    }

    @media (max-width: 1280px) {
      .image-grid {
        column-width: 200px;
        column-gap: 12px;
      }
    }

    @media (max-width: 900px) {
      .image-grid {
        padding: 24px;
        column-width: 190px;
        column-gap: 12px;
      }
    }

    .album-card {
      position: relative;
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-lg);
      background: #efe3ca;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
      height: 310px;
    }

    .album-card:hover {
      transform: translateY(-6px);
      border-color: rgba(79, 91, 68, 0.55);
    }

    .album-previews {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 4px;
      background: #d4dbc6;
      padding: 10px;
    }

    .album-thumb {
      position: relative;
      background: rgba(67, 83, 57, 0.22);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .album-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .album-card:hover .album-thumb img {
      transform: scale(1.03);
    }

    .album-thumb.placeholder {
      background: rgba(67, 83, 57, 0.28);
    }

    .album-overlay {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 18px 20px 16px;
      background: linear-gradient(180deg, rgba(23, 30, 22, 0.1) 0%, rgba(23, 30, 22, 0.85) 100%);
      color: #fdfcf8;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .album-name {
      font-size: 1.12rem;
      font-weight: 700;
      margin: 0;
    }

    .album-meta {
      font-size: 0.85rem;
      display: flex;
      gap: 12px;
      align-items: center;
      color: rgba(253, 252, 248, 0.82);
    }

    .album-meta span::before {
      content: "";
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: rgba(253, 252, 248, 0.6);
      margin-right: 10px;
    }

    .album-meta span:first-child::before {
      display: none;
    }

    .mosaic-item {
      position: relative;
      break-inside: avoid;
      margin-bottom: 16px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: #efe3ca;
      box-shadow: 0 10px 18px rgba(33, 49, 29, 0.14);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: zoom-in;
    }

    .mosaic-item img {
      display: block;
      width: 100%;
      height: auto;
      border-radius: inherit;
    }

    .mosaic-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 26px rgba(33, 49, 29, 0.18);
    }

    .mosaic-caption {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(17, 22, 16, 0) 0%, rgba(17, 22, 16, 0.82) 86%);
      color: #fdfcf8;
      opacity: 0;
      transition: opacity 0.2s ease;
      font-size: 0.82rem;
    }

    .mosaic-item:hover .mosaic-caption {
      opacity: 1;
    }

    .mosaic-caption strong {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .mosaic-caption span {
      display: block;
      color: rgba(245, 242, 234, 0.78);
      line-height: 1.3;
    }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
      font-size: 1rem;
      background: rgba(255,255,255,0.85);
      border: 1px dashed rgba(79, 91, 68, 0.35);
      border-radius: var(--radius-lg);
    }

    .hidden {
      display: none !important;
    }

    /* Lightbox */
    .lightbox-overlay {
      position: fixed;
      inset: 0;
      background: rgba(23, 30, 22, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 32px;
    }

    .lightbox-overlay.show {
      display: flex;
    }

    .lightbox-content {
      position: relative;
      max-width: 92vw;
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .lightbox-frame {
      position: relative;
      max-width: 92vw;
      max-height: 70vh;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-close {
      position: fixed;
      top: 28px;
      right: 32px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(23, 30, 22, 0.72);
      color: #f5f2ea;
      font-size: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .lightbox-close:hover {
      background: rgba(23, 30, 22, 0.9);
      transform: translateY(-2px);
    }

    .lightbox-media {
      max-width: 92vw;
      max-height: 70vh;
      border-radius: var(--radius-lg);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .lightbox-media.loaded {
      opacity: 1;
    }

    .lightbox-info {
      background: rgba(23, 30, 22, 0.86);
      padding: 20px 26px;
      border-radius: var(--radius-lg);
      color: #f5f2ea;
      max-width: 78vw;
      backdrop-filter: blur(6px);
    }

    .lightbox-title {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .lightbox-desc {
      margin: 10px 0 0;
      font-size: 0.97rem;
      color: rgba(243, 238, 230, 0.82);
    }

    .lightbox-tags {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tag-chip {
      appearance: none;
      border: none;
      background: rgba(245, 242, 234, 0.18);
      color: #f5f2ea;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .tag-chip:hover {
      background: rgba(245, 242, 234, 0.32);
      transform: translateY(-1px);
    }

    .lightbox-nav {
      position: fixed;
      top: 50%;
      left: 32px;
      right: 32px;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
      pointer-events: none;
    }

    .lightbox-btn {
      pointer-events: auto;
      width: 76px;
      height: 76px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(23, 30, 22, 0.6);
      border: 1px solid rgba(245, 242, 234, 0.4);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .lightbox-btn:hover {
      background: rgba(23, 30, 22, 0.82);
      transform: translateY(-2px);
    }

    .lightbox-btn svg {
      width: 36px;
      height: 36px;
      fill: #f5f2ea;
    }

    @media (max-width: 1024px) {
      #sidebar {
        display: none;
      }

      #contentHeader {
        padding: 24px 24px 12px;
      }

      .album-grid {
        padding: 24px;
      }

      .image-grid {
        padding: 24px;
        column-count: 3;
        column-gap: 14px;
      }
    }

    @media (max-width: 640px) {
      .album-grid {
        grid-template-columns: 1fr;
      }

      .image-grid {
        padding: 20px;
        column-count: 1;
        column-gap: 12px;
      }

      .lightbox-nav {
        left: 16px;
        right: 16px;
      }

      .lightbox-btn {
        width: 56px;
        height: 56px;
      }

      .lightbox-btn svg {
        width: 28px;
        height: 28px;
      }

      .lightbox-close {
        width: 48px;
        height: 48px;
        top: 20px;
        right: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <div class="sidebar-profile">
        <img src="assets/img/amarantha-avatar.svg" alt="amarantha profile photo">
        <div class="sidebar-name">
          <strong>amarantha</strong>
          <span>postcrossing collector</span>
        </div>
      </div>
      <div>
        <div class="sidebar-subtitle">Browse</div>
        <nav id="albumList" class="album-list"></nav>
      </div>
      <div>
        <div class="sidebar-subtitle">Tags</div>
        <div id="tagList"></div>
      </div>
    </aside>
    <main id="content">
      <section class="profile-hero">
        <div class="profile-avatar">
          <img src="assets/img/amarantha-avatar.svg" alt="Portrait of amarantha with her dog">
        </div>
        <div class="profile-copy">
          <h1>amarantha&rsquo;s albums for swap</h1>
          <p>A living collection of postcards ready to travel.</p>
        </div>
        <div class="profile-mark">
          <img src="assets/img/amarantha-logo.svg" alt="amarantha wordmark">
        </div>
      </section>
      <div id="contentHeader">
        <div class="header-left">
          <a id="backLink" class="back-link" href="#">Back to albums list</a>
          <div>
            <h2 id="viewTitle">Albums</h2>
            <p id="viewSubtitle">Overview of all albums</p>
          </div>
        </div>
      </div>
      <section id="albumsView" class="album-grid"></section>
      <section id="imagesView" class="image-grid hidden"></section>
    </main>
  </div>

  <div id="lightbox" class="lightbox-overlay" aria-hidden="true">
    <div class="lightbox-content" role="dialog" aria-modal="true" aria-label="Image preview" id="lightboxContent">
      <button class="lightbox-close" id="lightboxClose" aria-label="Close preview">&times;</button>
      <div class="lightbox-frame">
        <img id="lightboxImg" class="lightbox-media" alt="Preview image">
        <div class="lightbox-nav">
          <button class="lightbox-btn" id="lightboxPrev" aria-label="Previous image">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <button class="lightbox-btn" id="lightboxNext" aria-label="Next image">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m8.59 16.59 1.41 1.41 6-6-6-6-1.41 1.41L13.17 12z"/></svg>
          </button>
        </div>
      </div>
      <div class="lightbox-info" id="lightboxInfo">
        <h3 class="lightbox-title" id="lightboxTitle"></h3>
        <p class="lightbox-desc" id="lightboxDescription"></p>
        <div class="lightbox-tags" id="lightboxTags"></div>
      </div>
    </div>
  </div>

  <script>
    let galleryData = null;
    let tagLabels = {};
    let albums = [];
    let tagIndex = new Map();
    let tagList = [];
    let currentItems = [];
    let currentContext = { type: 'albums', value: null };
    let currentIndex = -1;
    let ignoreHashChange = false;
    const ALBUM_VIEWS_KEY = 'cardgallery_album_views';
    let albumViews = loadAlbumViews();
    const ALBUM_ORDER = [
      // Example: 'postcards/collection-01', 'Art'
    ];

    const sidebarTagList = document.getElementById('tagList');
    const albumListEl = document.getElementById('albumList');
    const albumsView = document.getElementById('albumsView');
    const imagesView = document.getElementById('imagesView');
    const viewTitle = document.getElementById('viewTitle');
    const viewSubtitle = document.getElementById('viewSubtitle');
    const backLink = document.getElementById('backLink');

    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxTitle = document.getElementById('lightboxTitle');
    const lightboxDescription = document.getElementById('lightboxDescription');
    const lightboxTags = document.getElementById('lightboxTags');

    function loadAlbumViews() {
      try {
        const raw = localStorage.getItem(ALBUM_VIEWS_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }

    function saveAlbumViews() {
      try {
        localStorage.setItem(ALBUM_VIEWS_KEY, JSON.stringify(albumViews));
      } catch {
        // Silent fail (e.g. private mode)
      }
    }

    function incrementAlbumView(id) {
      albumViews[id] = (albumViews[id] || 0) + 1;
      saveAlbumViews();
      return albumViews[id];
    }

    function getAlbumViews(id) {
      return albumViews[id] || 0;
    }

    function formatCount(value, singular, plural) {
      const abs = Math.abs(value);
      const word = abs === 1 ? singular : plural;
      return `${value} ${word}`;
    }

    function createAlbumOrderLookup() {
      const lookup = new Map();
      ALBUM_ORDER.forEach((entry, index) => {
        if (typeof entry !== 'string') return;
        lookup.set(entry.toLowerCase(), index);
      });
      return lookup;
    }

    function getAlbumOrderIndex(lookup, album) {
      const byId = lookup.get(album.id.toLowerCase());
      if (byId !== undefined) return byId;
      const byName = lookup.get(album.name.toLowerCase());
      if (byName !== undefined) return byName;
      return Number.MAX_SAFE_INTEGER;
    }

    function inferAlbumName(folder) {
      if (!folder) return 'Album';
      const parts = folder.split('/');
      return parts[parts.length - 1]
        .replace(/[-_]+/g, ' ')
        .replace(/\b\w/g, (c) => c.toUpperCase()) || 'Album';
    }

    function inferTitle(publicId) {
      if (!publicId) return 'Untitled';
      const base = publicId.split('/').pop() || publicId;
      return base
        .replace(/[-_]+/g, ' ')
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function normalizeItem(raw, folder) {
      const metadata = raw.context?.custom || {};
      const title = metadata.name?.trim() || raw.title?.trim() || inferTitle(raw.public_id || '');
      const description = metadata.desc?.trim() || raw.description?.trim() || '';
      const tags = Array.isArray(raw.tags) ? raw.tags : [];
      return {
        ...raw,
        folder,
        title,
        description,
        tags,
        displayTags: tags.map((tag) => ({
          code: tag,
          label: tagLabels[tag] || tag
        }))
      };
    }

    function buildTagIndex(items) {
      tagIndex = new Map();
      items.forEach((item) => {
        item.tags.forEach((tag) => {
          if (!tagIndex.has(tag)) {
            tagIndex.set(tag, []);
          }
          tagIndex.get(tag).push(item);
        });
      });
      tagList = Array.from(tagIndex.keys())
        .sort((a, b) => (tagLabels[a] || a).localeCompare(tagLabels[b] || b, undefined, { sensitivity: 'base' }));
    }

    function renderTagList() {
      sidebarTagList.innerHTML = '';
      if (!tagList.length) {
        const note = document.createElement('div');
        note.style.color = 'var(--muted)';
        note.style.fontSize = '0.9rem';
        note.textContent = 'Tags will appear once they are available.';
        sidebarTagList.appendChild(note);
        return;
      }

      tagList.forEach((tag) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tag-filter';
        btn.dataset.tag = tag;
        btn.textContent = tagLabels[tag] || tag;
        btn.addEventListener('click', () => navigateToTag(tag));
        sidebarTagList.appendChild(btn);
      });
      updateActiveFilters();
    }

    function renderAlbumList() {
      albumListEl.innerHTML = '';
      const overviewBtn = createAlbumLink('all', 'All albums');
      overviewBtn.classList.add('root');
      overviewBtn.addEventListener('click', () => showAlbums(true));
      albumListEl.appendChild(overviewBtn);

      albums.forEach((album) => {
        const btn = createAlbumLink(album.id, album.name);
        btn.addEventListener('click', () => showAlbum(album.id, true));
        albumListEl.appendChild(btn);
      });

      updateActiveFilters();
    }

    function createAlbumLink(id, label) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'album-link';
      btn.dataset.album = id;

      const labelSpan = document.createElement('span');
      labelSpan.className = 'label';
      labelSpan.textContent = label;

      btn.append(labelSpan);
      return btn;
    }

    function setBackLinkVisible(visible) {
      backLink.classList.toggle('visible', visible);
    }

    function updateActiveFilters() {
      document.querySelectorAll('.tag-filter').forEach((btn) => {
        btn.classList.toggle('active', currentContext.type === 'tag' && btn.dataset.tag === currentContext.value);
      });
      const activeAlbumId = currentContext.type === 'album' ? currentContext.value : null;
      const highlightAll = currentContext.type === 'albums';
      document.querySelectorAll('.album-link').forEach((btn) => {
        const datasetId = btn.dataset.album;
        const isActive = (highlightAll && datasetId === 'all') || (!!activeAlbumId && datasetId === activeAlbumId);
        btn.classList.toggle('active', isActive);
      });
    }

    function renderAlbums() {
      albumsView.innerHTML = '';
      if (!albums.length) {
        albumsView.innerHTML = '<div class="empty-state">No albums available yet.</div>';
        return;
      }

      albums.forEach((album) => {
        const card = document.createElement('article');
        card.className = 'album-card';

        const previews = document.createElement('div');
        previews.className = 'album-previews';
        const items = album.items.slice(0, 6);
        for (let i = 0; i < 6; i++) {
          const item = items[i];
          const cell = document.createElement('div');
          cell.className = 'album-thumb';
          if (item) {
            const img = document.createElement('img');
            img.src = item.thumb;
            img.alt = item.title;
            cell.appendChild(img);
          } else {
            cell.classList.add('placeholder');
          }
          previews.appendChild(cell);
        }

        const overlay = document.createElement('div');
        overlay.className = 'album-overlay';
        const name = document.createElement('div');
        name.className = 'album-name';
        name.textContent = album.name;

        const meta = document.createElement('div');
        meta.className = 'album-meta';
        const count = document.createElement('span');
        count.textContent = formatCount(album.items.length, 'photo', 'photos');
        const views = document.createElement('span');
        views.textContent = formatCount(getAlbumViews(album.id), 'view', 'views');
        meta.append(count, views);

        overlay.append(name, meta);
        card.append(previews, overlay);
        card.addEventListener('click', () => navigateToAlbum(album.id));

        albumsView.appendChild(card);
      });
    }

    function renderImageGrid(items) {
      currentItems = items;
      imagesView.innerHTML = '';

      if (!items.length) {
        imagesView.innerHTML = '<div class="empty-state">No images match this filter.</div>';
        return;
      }

      const fragment = document.createDocumentFragment();

      items.forEach((item, index) => {
        const figure = document.createElement('figure');
        figure.className = 'mosaic-item';

        const img = document.createElement('img');
        img.src = transformCloudinaryUrl(item.url, 820);
        img.alt = item.title || item.public_id;
        img.loading = 'lazy';
        figure.appendChild(img);

        if (item.title || item.description) {
          const caption = document.createElement('figcaption');
          caption.className = 'mosaic-caption';
          const titleEl = document.createElement('strong');
          titleEl.textContent = item.title || item.public_id;
          caption.appendChild(titleEl);
          if (item.description) {
            const descEl = document.createElement('span');
            descEl.textContent = item.description;
            caption.appendChild(descEl);
          }
          figure.appendChild(caption);
        }

        figure.addEventListener('click', (event) => {
          event.preventDefault();
          openLightbox(index);
        });

        fragment.appendChild(figure);
      });

      imagesView.appendChild(fragment);
    }

    function createTagChip(tag) {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'tag-chip';
      chip.textContent = tag.label;
      chip.addEventListener('click', (event) => {
        event.stopPropagation();
        handleTagSelection(tag.code);
      });
      return chip;
    }

    function showAlbums(updateHash = false) {
      currentContext = { type: 'albums', value: null };
      viewTitle.textContent = 'Albums';
      viewSubtitle.textContent = 'Overview of all albums';
      setBackLinkVisible(false);
      albumsView.classList.remove('hidden');
      imagesView.classList.add('hidden');
      renderAlbums();
      updateActiveFilters();
      if (updateHash) {
        navigateHash('albums');
      }
    }

    function showAlbum(albumId, updateHash = false) {
      const album = albums.find((a) => a.id === albumId);
      if (!album) {
        showAlbums(true);
        return;
      }

      currentContext = { type: 'album', value: albumId };
      const totalViews = incrementAlbumView(albumId);
      viewTitle.textContent = album.name;
      viewSubtitle.textContent = `${formatCount(album.items.length, 'photo', 'photos')} | ${formatCount(totalViews, 'view', 'views')}`;
      setBackLinkVisible(true);

      albumsView.classList.add('hidden');
      imagesView.classList.remove('hidden');
      renderImageGrid(album.items);
      updateActiveFilters();

      if (updateHash) {
        navigateHash('album', albumId);
      }
    }

    function showTag(tagCode, updateHash = false) {
      if (!tagIndex.has(tagCode)) {
        showAlbums(true);
        return;
      }
      currentContext = { type: 'tag', value: tagCode };
      const items = tagIndex.get(tagCode);
      const label = tagLabels[tagCode] || tagCode;

      viewTitle.textContent = label;
      viewSubtitle.textContent = `${formatCount(items.length, 'photo', 'photos')} with this tag`;
      setBackLinkVisible(true);

      albumsView.classList.add('hidden');
      imagesView.classList.remove('hidden');
      renderImageGrid(items);
      updateActiveFilters();

      if (updateHash) {
        navigateHash('tag', tagCode);
      }
    }

    function handleTagSelection(tagCode) {
      closeLightbox();
      showTag(tagCode, true);
    }

    function navigateToAlbum(albumId) {
      showAlbum(albumId, true);
    }

    function navigateToTag(tagCode) {
      showTag(tagCode, true);
    }

    function navigateHash(view, value) {
      ignoreHashChange = true;
      if (view === 'albums') {
        location.hash = '';
      } else {
        location.hash = `#${view}=${encodeURIComponent(value)}`;
      }
    }

    function parseHash() {
      const hash = location.hash.replace('#', '');
      if (!hash) return { view: 'albums', value: null };
      const [rawKey, rawValue] = hash.split('=');
      if (!rawKey || !rawValue) return { view: 'albums', value: null };
      return { view: rawKey, value: decodeURIComponent(rawValue) };
    }

    window.addEventListener('hashchange', () => {
      if (ignoreHashChange) {
        ignoreHashChange = false;
        return;
      }
      const { view, value } = parseHash();
      if (view === 'album' && value) showAlbum(value);
      else if (view === 'tag' && value) showTag(value);
      else showAlbums();
    });

    function transformCloudinaryUrl(url, width) {
      try {
        const marker = '/upload/';
        const idx = url.indexOf(marker);
        if (idx !== -1) {
          const prefix = url.substring(0, idx + marker.length);
          const suffix = url.substring(idx + marker.length);
          return `${prefix}c_limit,f_auto,q_auto,w_${width}/${suffix}`;
        }
      } catch (err) {
        console.warn('Failed to transform URL', err);
      }
      return url;
    }

    function transformUrlForPreview(url) {
      return transformCloudinaryUrl(url, 1200);
    }

    function renderLightbox(idx) {
      const item = currentItems[idx];
      if (!item) return;
      currentIndex = idx;

      const previewUrl = transformUrlForPreview(item.url);
      lightboxImg.classList.remove('loaded');
      lightboxTitle.textContent = item.title;
      lightboxDescription.textContent = item.description || '';
      lightboxDescription.classList.toggle('hidden', !item.description);

      lightboxTags.innerHTML = '';
      item.displayTags.forEach((tag) => {
        lightboxTags.appendChild(createTagChip(tag));
      });
      lightboxTags.classList.toggle('hidden', !item.displayTags.length);

      const pre = new Image();
      pre.onload = () => {
        lightboxImg.src = previewUrl;
        lightboxImg.alt = item.title || 'Preview image';
        lightboxImg.classList.add('loaded');
      };
      pre.onerror = () => {
        lightboxImg.src = previewUrl;
        lightboxImg.classList.add('loaded');
      };
      pre.src = previewUrl;
    }

    function openLightbox(idx) {
      renderLightbox(idx);
      lightbox.classList.add('show');
      lightbox.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      document.getElementById('lightboxClose').focus({ preventScroll: true });
    }

    function closeLightbox() {
      lightbox.classList.remove('show');
      lightbox.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      currentIndex = -1;
    }

    function nextItem() {
      if (!currentItems.length) return;
      currentIndex = (currentIndex + 1) % currentItems.length;
      renderLightbox(currentIndex);
    }

    function prevItem() {
      if (!currentItems.length) return;
      currentIndex = (currentIndex - 1 + currentItems.length) % currentItems.length;
      renderLightbox(currentIndex);
    }

    function initialiseEvents() {
      const overlay = document.getElementById('lightbox');
      const content = document.getElementById('lightboxContent');
      document.getElementById('lightboxClose').addEventListener('click', closeLightbox);
      document.getElementById('lightboxNext').addEventListener('click', (event) => {
        event.stopPropagation();
        nextItem();
      });
      document.getElementById('lightboxPrev').addEventListener('click', (event) => {
        event.stopPropagation();
        prevItem();
      });
      overlay.addEventListener('click', (event) => {
        if (!content.contains(event.target)) closeLightbox();
      });
      window.addEventListener('keydown', (event) => {
        if (!overlay.classList.contains('show')) return;
        if (event.key === 'Escape') closeLightbox();
        if (event.key === 'ArrowRight') nextItem();
        if (event.key === 'ArrowLeft') prevItem();
      });
    }

    function initialiseSidebar() {
      backLink.addEventListener('click', (event) => {
        event.preventDefault();
        showAlbums(true);
      });
    }

    function initialiseGallery(data) {
      const folders = data.folders || {};
      const albumEntries = Object.keys(folders);
      const orderLookup = createAlbumOrderLookup();
      albums = albumEntries
        .map((folder) => {
          const items = (folders[folder] || []).map((item) => normalizeItem(item, folder));
          return {
            id: folder,
            name: inferAlbumName(folder.replace(new RegExp('^' + (data.root || '') + '/?'), '')),
            items
          };
        })
        .filter((album) => album.items.length > 0)
        .sort((a, b) => {
          const diff = getAlbumOrderIndex(orderLookup, a) - getAlbumOrderIndex(orderLookup, b);
          if (diff !== 0) return diff;
          return a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
        });

      const allItems = albums.flatMap((album) => album.items);
      buildTagIndex(allItems);
      renderTagList();
      renderAlbumList();

      const { view, value } = parseHash();
      if (view === 'album' && value) {
        showAlbum(value);
      } else if (view === 'tag' && value) {
        showTag(value);
      } else {
        showAlbums();
      }
    }

    function fetchTags() {
      return fetch('tags.json')
        .then((response) => {
          if (!response.ok) throw new Error('Tag file not found');
          return response.json();
        })
        .catch(() => ({}));
    }

    function bootstrap() {
      initialiseEvents();
      initialiseSidebar();
      Promise.all([
        fetch('gallery.json').then((response) => response.json()),
        fetchTags()
      ])
        .then(([gallery, tags]) => {
          galleryData = gallery;
          tagLabels = tags || {};
          initialiseGallery(galleryData);
        })
        .catch((error) => {
          console.error(error);
          viewTitle.textContent = 'Failed to load gallery';
          viewSubtitle.textContent = 'Please check that gallery.json is available.';
          albumsView.innerHTML = '<div class="empty-state">Failed to load gallery data.</div>';
        });
    }

    window.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>

