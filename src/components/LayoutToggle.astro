---
const {
  targetId,
  defaultMode = 'classic'
} = Astro.props;

const modes = [
  {
    id: 'classic',
    label: 'Classic layout',
    icon: 'classic'
  },
  {
    id: 'big-mobile',
    label: 'Big mobile layout',
    icon: 'big'
  }
];
---
<div
  class="layout-toggle"
  data-layout-toggle
  data-target={targetId ?? ''}
  data-default={defaultMode}
>
  {modes.map(mode => (
    <button
      type="button"
      class="layout-toggle__button"
      data-mode={mode.id}
      aria-pressed="false"
    >
      <span class="layout-toggle__icon" aria-hidden="true">
        {mode.icon === 'classic' ? (
          <svg width="28" height="22" viewBox="0 0 28 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="9" height="8" rx="2" fill="currentColor" />
            <rect x="12" y="1" width="7" height="3.5" rx="1.5" fill="currentColor" />
            <rect x="21" y="1" width="6" height="5.5" rx="1.5" fill="currentColor" />
            <rect x="12" y="6" width="6.5" height="3" rx="1.5" fill="currentColor" />
            <rect x="1" y="12" width="6" height="8" rx="2" fill="currentColor" />
            <rect x="9" y="12" width="9" height="8" rx="2" fill="currentColor" />
            <rect x="20" y="12" width="7" height="8" rx="2" fill="currentColor" />
          </svg>
        ) : (
          <svg width="28" height="22" viewBox="0 0 28 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="16" height="9" rx="2" fill="currentColor" />
            <rect x="19" y="1" width="8" height="9" rx="2" fill="currentColor" />
            <rect x="1" y="12" width="11" height="9" rx="2" fill="currentColor" />
            <rect x="14" y="12" width="13" height="9" rx="2" fill="currentColor" />
          </svg>
        )}
      </span>
      <span class="layout-toggle__sr-only">{mode.label}</span>
    </button>
  ))}
</div>
<script>
  (() => {
    const storageKey = 'cardgallery-layout-mode';
    const initialised = new WeakSet();

    const updateButtonState = (buttons, mode) => {
      buttons.forEach(btn => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    };

    const resolveTarget = (id, fallback) => {
      if (fallback && fallback.id === id && document.body.contains(fallback)) {
        return fallback;
      }
      return document.getElementById(id) || null;
    };

    const setupToggle = root => {
      if (!root || initialised.has(root)) return;

      const targetId = root.dataset.target || '';
      const defaultMode = root.dataset.default || 'classic';
      const buttons = Array.from(root.querySelectorAll('[data-mode]'));
      if (!targetId || buttons.length === 0) return;

      const availableModes = new Set(buttons.map(btn => btn.dataset.mode));
      let target = resolveTarget(targetId, null);
      let queuedMode = null;

      const applyMode = mode => {
        const nextMode = availableModes.has(mode) ? mode : defaultMode;
        updateButtonState(buttons, nextMode);
        queuedMode = nextMode;
        target = resolveTarget(targetId, target);
        if (!target) {
          return;
        }
        queuedMode = null;
        if (target.dataset.layoutMode !== nextMode) {
          target.dataset.layoutMode = nextMode;
        }
        try {
          localStorage.setItem(storageKey, nextMode);
        } catch (error) {
          /* ignore storage errors */
        }
      };

      let initialMode = defaultMode;
      try {
        const stored = localStorage.getItem(storageKey);
        if (stored && availableModes.has(stored)) {
          initialMode = stored;
        }
      } catch (error) {
        /* ignore storage errors */
      }

      buttons.forEach(btn => {
        btn.addEventListener('click', event => {
          event.preventDefault();
          applyMode(btn.dataset.mode);
        });
      });

      if (!target) {
        const observer = new MutationObserver(() => {
          target = resolveTarget(targetId, target);
          if (target) {
            observer.disconnect();
            const modeToApply = queuedMode || initialMode;
            applyMode(modeToApply);
          }
        });
        observer.observe(document.documentElement, {
          childList: true,
          subtree: true
        });
      }

      applyMode(initialMode);
      initialised.add(root);
    };

    const initialiseAll = () => {
      document
        .querySelectorAll('[data-layout-toggle]')
        .forEach(root => setupToggle(root));
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialiseAll, { once: true });
    } else {
      initialiseAll();
    }

    document.addEventListener('astro:page-load', initialiseAll);
    document.addEventListener('astro:after-swap', initialiseAll);
  })();
</script>
<style>
  .layout-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem;
    border-radius: 999px;
    border: 1px solid rgba(67, 83, 57, 0.25);
    background: rgba(255, 255, 255, 0.78);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.08);
  }

  .layout-toggle__button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.1rem;
    border-radius: 0.65rem;
    border: 1px solid transparent;
    background: transparent;
    color: rgba(83, 95, 86, 0.78);
    transition: background 0.18s ease-out, color 0.18s ease-out, border-color 0.18s ease-out, transform 0.18s ease-out;
    cursor: pointer;
  }

  .layout-toggle__button:hover {
    transform: translateY(-1px);
    border-color: rgba(67, 83, 57, 0.32);
    color: rgba(67, 83, 57, 0.95);
  }

  .layout-toggle__button:focus-visible {
    outline: 3px solid rgba(134, 212, 140, 0.9);
    outline-offset: 2px;
  }

  .layout-toggle__button.is-active {
    background: #1d6ecb;
    color: #f0f6fe;
    border-color: rgba(20, 90, 170, 0.82);
  }

  .layout-toggle__icon {
    display: inline-flex;
  }

  .layout-toggle__sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (min-width: 1024px) {
    .layout-toggle {
      display: none;
    }
  }
</style>
