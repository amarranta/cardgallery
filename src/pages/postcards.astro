---
import BaseLayout from '../layouts/BaseLayout.astro';
import Sidebar from '../components/Sidebar.astro';
import ProfileHero from '../components/ProfileHero.astro';
import ViewHeader from '../components/ViewHeader.astro';
import ImageGrid from '../components/ImageGrid.astro';
import LayoutToggle from '../components/LayoutToggle.astro';
import TagList from '../components/TagList.astro';
import { getAlbums, getTags, getAllItems, hero, site } from '../data/gallery.js';

const albums = getAlbums();
const tags = getTags();
const allItems = getAllItems();
const sortedItems = allItems
  .slice()
  .sort((a, b) => {
    const orderA = Number.isFinite(a.albumOrderIndex) ? a.albumOrderIndex : Number.POSITIVE_INFINITY;
    const orderB = Number.isFinite(b.albumOrderIndex) ? b.albumOrderIndex : Number.POSITIVE_INFINITY;
    if (orderA !== orderB) {
      return orderA - orderB;
    }
    const nameA = a.albumName ?? '';
    const nameB = b.albumName ?? '';
    if (nameA === nameB) {
      return (a.albumIndex ?? 0) - (b.albumIndex ?? 0);
    }
    return nameA.localeCompare(nameB, undefined, { sensitivity: 'base' });
  });

const totalPostcards = sortedItems.length;
const albumCount = albums.length;
const gridId = 'all-postcards-grid';

const postcardLabel = `${totalPostcards} ${totalPostcards === 1 ? 'postcard' : 'postcards'}`;
const albumLabel = `${albumCount} ${albumCount === 1 ? 'folder' : 'folders'}`;
const subtitle = `${postcardLabel} across ${albumLabel}, sorted by album name`;
---
<BaseLayout title={`All postcards â€¢ ${site.title}`} description={`Browse every postcard available on ${site.title}`}>
  <div class="flex min-h-screen flex-col lg:flex-row">
    <Sidebar albums={albums} tags={tags} activeCollection="postcards" />
    <main class="flex flex-1 flex-col overflow-hidden">
      <ProfileHero {...hero} />
      <ViewHeader title="All postcards" subtitle={subtitle} backHref={import.meta.env.BASE_URL} backLabel="Back to all folders" data-i18n-type="page" />
      <div class="flex justify-end px-6 pt-2 md:px-9">
        <LayoutToggle targetId={gridId} />
      </div>
      <ImageGrid items={sortedItems} gridId={gridId} />
      {tags.length > 0 && (
        <section class="pb-12">
          <h3 class="px-6 text-sm font-semibold uppercase tracking-[0.3em] text-[var(--text-muted)] md:px-9" data-i18n="nav.browseByTag">
            Browse by tag
          </h3>
          <TagList tags={tags} />
        </section>
      )}
    </main>
  </div>
</BaseLayout>

<script>
  import { getUserLocale, t, tPlural } from '../i18n';
  
  // Get counts from page data
  const totalPostcards = {totalPostcards};
  const albumCount = {albumCount};
  
  // Localize page title and subtitle with pluralization
  const locale = getUserLocale();
  const titleEl = document.querySelector('[data-i18n-title="true"]');
  const subtitleEl = document.querySelector('[data-i18n-subtitle="true"]');
  const backEl = document.querySelector('[data-i18n-back="true"]');
  
  if (titleEl) {
    titleEl.textContent = t(locale, 'header.allPostcardsTitle');
  }
  
  if (subtitleEl) {
    const postcardText = tPlural(locale, 'postcards.postcard', totalPostcards);
    const folderText = tPlural(locale, 'postcards.folder', albumCount);
    subtitleEl.textContent = postcardText + ' ' + folderText;
  }
  
  if (backEl) {
    backEl.textContent = t(locale, 'header.backToFolders');
  }
</script>
