---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidebar from '../../components/Sidebar.astro';
import ProfileHero from '../../components/ProfileHero.astro';
import ViewHeader from '../../components/ViewHeader.astro';
import ImageGrid from '../../components/ImageGrid.astro';
import LayoutToggle from '../../components/LayoutToggle.astro';
import TagList from '../../components/TagList.astro';
import { getAlbums, getTags, getItemById, getItemPaths, getAlbumBySlug, hero, site } from '../../data/gallery.js';
import { filterVisibleTags } from '../../data/tag-visibility.js';

export function getStaticPaths() {
  return getItemPaths();
}

const { id } = Astro.params;
const item = getItemById(id);

if (!item) {
  return Astro.redirect('/404.html');
}

const albums = getAlbums();
const tags = getTags();

// Get the album this item belongs to
const parentAlbum = getAlbumBySlug(item.albumSlug);

// Use album items if available, otherwise fallback to just this item
const albumItems = parentAlbum ? parentAlbum.items : [item];
const itemIndex = albumItems.findIndex(i => i.id === id);

const pageTitle = item.metadata?.name || item.title || 'Postcard';
const pageDescription = item.metadata?.desc || item.description || `View ${pageTitle} on ${site.title}`;
const backLabel = item.albumName ? `Back to ${item.albumName}` : 'Back to all postcards';
const backHref = item.albumSlug ? `${import.meta.env.BASE_URL}album/${item.albumSlug}` : `${import.meta.env.BASE_URL}postcards`;

const gridId = `postcard-grid-${item.albumSlug || 'single'}`;
const visibleItemTags = filterVisibleTags(Array.isArray(item.tagDetails) ? item.tagDetails : []);

// Use the postcard's preview image for OG tags
const ogImageUrl = item.previewUrl || item.gridUrl || item.thumbUrl;
---
<BaseLayout title={`${pageTitle} â€¢ ${site.title}`} description={pageDescription} ogImage={ogImageUrl}>
  <div class="flex min-h-screen flex-col lg:flex-row">
    <Sidebar albums={albums} tags={tags} activeAlbum={item.albumSlug} activeCollection="folders" />
    <main class="flex flex-1 flex-col overflow-hidden">
      <ProfileHero {...hero} />
      <ViewHeader 
        title={item.albumName || 'Postcard'}
        subtitle={item.metadata?.author ? `by ${item.metadata.author}` : (item.metadata?.desc || '')} 
        backHref={backHref} 
        backLabel={backLabel} 
      />
      <div class="flex justify-end px-6 pt-2 md:px-9">
        <LayoutToggle targetId={gridId} />
      </div>
      <ImageGrid items={albumItems} gridId={gridId} />
      {visibleItemTags.length > 0 && (
        <section class="pb-12">
          <h3 class="px-6 text-sm font-semibold uppercase tracking-[0.3em] text-muted md:px-9">
            Tags on this postcard
          </h3>
          <TagList tags={visibleItemTags} />
        </section>
      )}
    </main>
  </div>
</BaseLayout>

<script define:vars={{ itemIndex }}>
  // Auto-open the lightbox for this specific postcard when page loads
  if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', () => {
      // Wait a brief moment for the gallery to initialize
      setTimeout(() => {
        const root = document.querySelector('[data-lightbox-root]');
        if (root && root.__lightboxInstance) {
          root.__lightboxInstance.openLightbox(itemIndex);
        }
      }, 100);
    });
  }
</script>
