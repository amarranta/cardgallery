---
import BaseLayout from '../layouts/BaseLayout.astro';
import WorldMap from '../components/map/WorldMap';
import travelPoints from '../data/travel-points.json';
import { getVisibleItems, site } from '../data/gallery.js';
import rawGallery from '../data/gallery.json';
import { Cloudinary } from '@cloudinary/url-gen';
import { fill, limitFit } from '@cloudinary/url-gen/actions/resize';
import { autoGravity } from '@cloudinary/url-gen/qualifiers/gravity';

type TravelPoint = (typeof travelPoints)[number];

const baseUrl = import.meta.env.BASE_URL || '/';

const allItems = getVisibleItems();

const cloudName = rawGallery?.cloudName || null;
const cld = cloudName ? new Cloudinary({ cloud: { cloudName } }) : null;

function buildCloudinaryUrls(publicId: string) {
  if (!publicId || !cld) return null;

  const previewImage = cld.image(publicId);
  previewImage.format('auto').quality('auto');
  previewImage.resize(limitFit().width(1200));

  const mapDesktopImage = cld.image(publicId);
  mapDesktopImage.format('auto').quality('auto');
  mapDesktopImage.resize(limitFit().width(800));

  const mapImage = cld.image(publicId);
  mapImage.format('auto').quality('auto');
  mapImage.resize(limitFit().width(400));

  const thumbImage = cld.image(publicId);
  thumbImage.format('auto').quality('auto');
  thumbImage.resize(fill().width(480).height(360).gravity(autoGravity()));

  return {
    previewUrl: previewImage.toURL(),
    mapUrl: mapDesktopImage.toURL(),
    mapCompactUrl: mapImage.toURL(),
    thumbUrl: thumbImage.toURL()
  };
}

type MapPostcard = {
  id: string;
  title?: string | null;
  description?: string | null;
  metadataDesc?: string | null;
  mapCompactUrl?: string | null;
  mapUrl?: string | null;
  thumbUrl: string;
  previewUrl: string;
};

const postcards = (travelPoints as TravelPoint[])
  .map(point => {
    const explicitId = (point.postcardId || '').trim();
    if (explicitId) {
      const item = allItems.find(candidate => candidate.id === explicitId);
      if (item) {
        const optimized = cld ? buildCloudinaryUrls(item.id) : null;
        const card: MapPostcard = {
          id: item.id,
          title: item.title ?? null,
          description: item.description ?? null,
          metadataDesc: item?.metadata?.desc ?? null,
          mapCompactUrl: optimized?.mapCompactUrl ?? optimized?.mapUrl ?? optimized?.previewUrl ?? item.previewUrl,
          mapUrl: optimized?.mapUrl ?? optimized?.previewUrl ?? item.previewUrl,
          thumbUrl: optimized?.thumbUrl ?? item.thumbUrl,
          previewUrl: optimized?.previewUrl ?? item.previewUrl
        };
        return card;
      }

      // If the postcard isn't part of `gallery.json` yet, still show it on the map
      // (Cloudinary public_id is enough to generate URLs).
      const urls = buildCloudinaryUrls(explicitId);
      if (urls) {
        const card: MapPostcard = {
          id: explicitId,
          title: point.city ?? null,
          description: point.description ?? null,
          metadataDesc: null,
          mapCompactUrl: urls.mapCompactUrl ?? urls.mapUrl ?? urls.previewUrl,
          mapUrl: urls.mapUrl ?? urls.previewUrl,
          thumbUrl: urls.thumbUrl,
          previewUrl: urls.previewUrl
        };
        return card;
      }
    }

    // Recommended flow: Cloudinary structured metadata `placeId` === `point.id`
    const byPlaceId = allItems.find(candidate => candidate.placeId === point.id);
    if (!byPlaceId) return null;

    const optimized = cld ? buildCloudinaryUrls(byPlaceId.id) : null;

    const card: MapPostcard = {
      id: byPlaceId.id,
      title: byPlaceId.title ?? null,
      description: byPlaceId.description ?? null,
      metadataDesc: byPlaceId?.metadata?.desc ?? null,
      mapCompactUrl: optimized?.mapCompactUrl ?? optimized?.mapUrl ?? optimized?.previewUrl ?? byPlaceId.previewUrl,
      mapUrl: optimized?.mapUrl ?? optimized?.previewUrl ?? byPlaceId.previewUrl,
      thumbUrl: optimized?.thumbUrl ?? byPlaceId.thumbUrl,
      previewUrl: optimized?.previewUrl ?? byPlaceId.previewUrl
    };
    return card;
  })
  .filter((item): item is MapPostcard => Boolean(item));
---

<BaseLayout title={`Map • ${site.title}`} description={`Visited places on the map • ${site.title}`} bodyClass="overflow-hidden" hideFooter={true}>
  <main class="h-[100dvh] min-h-[520px]">
    <WorldMap client:only="react" baseUrl={baseUrl} points={travelPoints} postcards={postcards} />
  </main>
</BaseLayout>
