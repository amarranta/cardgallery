class E{constructor(t){this.root=t,this.gridEl=t.querySelector("[data-justified-grid]"),this.overlay=t.querySelector("[data-lightbox]"),this.imageEl=this.overlay?.querySelector("[data-lightbox-image]")||null,this.nameEl=this.overlay?.querySelector("[data-lightbox-name]")||null,this.descEl=this.overlay?.querySelector("[data-lightbox-desc]")||null,this.authorEl=this.overlay?.querySelector("[data-lightbox-author]")||null,this.tagsWrapper=this.overlay?.querySelector("[data-lightbox-tags-wrapper]")||null,this.tagsContainer=this.overlay?.querySelector("[data-lightbox-tags]")||null,this.closeBtn=this.overlay?.querySelector("[data-lightbox-close]")||null,this.nextBtn=this.overlay?.querySelector("[data-lightbox-next]")||null,this.prevBtn=this.overlay?.querySelector("[data-lightbox-prev]")||null,this.items=this.parseItems(t.dataset.lightboxItems),this.base=t.dataset.lightboxBase||"/",this.layoutMode=t.dataset.layoutMode||"classic",this.baseTargetHeight=Number(this.gridEl?.dataset.rowHeight)||400,this.baseGap=Number(this.gridEl?.dataset.rowGap),(!Number.isFinite(this.baseGap)||this.baseGap<0)&&(this.baseGap=12),this.swipeArea=this.overlay?.querySelector("[data-lightbox-swipe]")||null,this.swipeState=null,this.swipeThreshold=60,this.maxVerticalDelta=80,this.triggers=[],this.activeIndex=0,this.previousOverflow="",this.handleKeyDown=this.handleKeyDown.bind(this),this.handleOverlayClick=this.handleOverlayClick.bind(this),this.handleCloseClick=this.handleCloseClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handlePrevClick=this.handlePrevClick.bind(this),this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),this.handlePointerCancel=this.handlePointerCancel.bind(this),!(!this.gridEl||!this.items.length)&&(this.setupOverlayControls(),this.renderGrid(),typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(()=>{this.renderGrid()}),this.resizeObserver.observe(this.root)),typeof MutationObserver<"u"&&(this.attributeObserver=new MutationObserver(i=>{for(const e of i)if(e.type==="attributes"&&e.attributeName==="data-layout-mode"){const o=this.root.dataset.layoutMode||"classic";o!==this.layoutMode&&(this.layoutMode=o,this.renderGrid())}}),this.attributeObserver.observe(this.root,{attributes:!0,attributeFilter:["data-layout-mode"]})))}parseItems(t){if(!t)return[];try{const i=JSON.parse(decodeURIComponent(t));return Array.isArray(i)?i:[]}catch(i){return console.warn("Failed to parse justified gallery items",i),[]}}getAspect(t){const i=Number(t?.aspectRatio);if(Number.isFinite(i)&&i>0)return i;const e=Number(t?.width),o=Number(t?.height);return Number.isFinite(e)&&Number.isFinite(o)&&o>0?e/o:1.5}getResponsiveTargetHeight(t){const i=typeof window<"u"?window.innerWidth:t,e=this.baseTargetHeight||400;if(!Number.isFinite(e)||e<=0)return 400;const o=Math.max(160,Math.min(e,220)),r=Math.max(200,Math.min(e,280)),s=Math.max(240,Math.min(e,340));return i<=480||t<=480?o:i<=768?r:i<=1024?s:e}getResponsiveRowScale(t){const i=typeof window<"u"?window.innerWidth:t;return i<=480||t<=480?{min:.55,max:1.25}:i<=768?{min:.6,max:1.3}:{min:.7,max:1.35}}getResponsiveGap(t){const i=typeof window<"u"?window.innerWidth:t,e=Number.isFinite(this.baseGap)?this.baseGap:12;return i<=480||t<=480?Math.max(6,Math.min(e,8)):i<=768?Math.max(7,Math.min(e,10)):e}renderGrid(){if(!this.gridEl)return;const t=this.gridEl.clientWidth||this.gridEl.offsetWidth;if(!t){requestAnimationFrame(()=>this.renderGrid());return}const i=this.getResponsiveGap(t);this.gridEl.style.setProperty("--row-gap",`${i}px`),this.gridEl.innerHTML="",this.triggers=[];const e=this.items,r=this.layoutMode==="big-mobile"&&t<=640;if(this.gridEl.classList.toggle("is-mobile-big",r),r){this.buildMobileRows(e).forEach(m=>{const f=document.createElement("div"),h="big-layout-row",p=`big-layout-row--${m.variant}`,y=m.variant==="pair-portrait"?"big-layout-row--pair":"big-layout-row--single";f.className=`${h} ${y} ${p}`,m.items.forEach(b=>{const g=this.createTrigger(b.item,b.index),w=b.aspect>=1?"landscape":"portrait";g.classList.add("justified-item--big",`justified-item--${w}`),g.style.height="auto",g.style.width="100%",g.style.flex="0 0 auto",g.style.aspectRatio=String(b.aspect),g.style.setProperty("--big-aspect",String(b.aspect)),f.appendChild(g)}),this.gridEl.appendChild(f)}),this.refreshNavVisibility();return}const s=this.getResponsiveTargetHeight(t),{min:l,max:a}=this.getResponsiveRowScale(t);let n=[],d=0;const c=u=>{if(!n.length)return;let f=(t-i*(n.length-1))/d;const h=Math.max(s*l,Math.min(s*a,f)),p=u?s:h,y=document.createElement("div");y.className="justified-row",y.style.height=`${p}px`,u&&y.classList.add("justified-row--last"),n.forEach(b=>{const g=this.createTrigger(b.item,b.index);u?(g.style.flex="0 0 auto",g.style.width=`${p*b.aspect}px`,g.style.height=`${p}px`):(g.style.flex=`${b.aspect} 1 0`,g.style.height=`${p}px`),y.appendChild(g)}),this.gridEl.appendChild(y),n=[],d=0};e.forEach((u,m)=>{const f=this.getAspect(u);n.push({item:u,aspect:f,index:m}),d+=f,d*s+i*(n.length-1)>=t&&c(!1)}),n.length&&c(!0),this.refreshNavVisibility()}clampAspect(t,i=1){if(!Number.isFinite(t)||t<=0)return i;const e=Number(t.toFixed(5));return Math.min(2.6,Math.max(.4,e))}buildMobileRows(t){const i=[];if(!Array.isArray(t)||t.length===0)return i;let e=0;const o=t.length;for(;e<o;){const r=t[e],s=this.getAspect(r),l=this.clampAspect(s,1.25);if(s>=1){i.push({variant:"single-landscape",items:[{item:r,index:e,aspect:l}]}),e+=1;continue}const n=[];for(;e<o;){const c=t[e],u=this.getAspect(c);if(u>=1)break;n.push({item:c,index:e,aspect:this.clampAspect(u,.8)}),e+=1}let d=0;for(;d<n.length;)n.length-d>=2?(i.push({variant:"pair-portrait",items:[n[d],n[d+1]]}),d+=2):(i.push({variant:"single-portrait",items:[n[d]]}),d+=1)}return i}createTrigger(t,i){const e=document.createElement("button");e.type="button",e.dataset.lightboxTrigger="",e.dataset.index=String(i),e.className="justified-item";const o=t.name||t.title,r=o?`Open ${o} in lightbox`:"Open image in lightbox";e.setAttribute("aria-label",r);const s=document.createElement("img");if(s.src=t.grid||t.preview||t.thumb,s.alt=t.name||t.title||"Gallery image",s.loading="lazy",s.decoding="async",function(a,n){const d=n||"/",u=`${d.endsWith("/")?d:`${d}/`}assets/img/unavailable.svg`;a.addEventListener("error",function m(){a.dataset.fallbackApplied||(a.dataset.fallbackApplied="1",a.removeEventListener("error",m),a.src=u,a.alt="Not available",a.classList.add("is-fallback"))})}(s,this.base),e.appendChild(s),t.name||t.desc){const l=document.createElement("div");if(l.className="justified-item__overlay",t.name){const a=document.createElement("strong");a.className="justified-item__title",a.textContent=t.name,l.appendChild(a)}if(t.desc){const a=document.createElement("p");a.className="justified-item__desc",a.textContent=t.desc,l.appendChild(a)}e.appendChild(l)}return e.addEventListener("click",l=>{l.preventDefault(),this.openLightbox(i)}),this.triggers[i]=e,e}setupOverlayControls(){this.overlay&&(this.overlay.addEventListener("click",this.handleOverlayClick),this.closeBtn?.addEventListener("click",this.handleCloseClick),this.nextBtn?.addEventListener("click",this.handleNextClick),this.prevBtn?.addEventListener("click",this.handlePrevClick),this.swipeArea&&(this.swipeArea.addEventListener("pointerdown",this.handlePointerDown),this.swipeArea.addEventListener("pointermove",this.handlePointerMove),this.swipeArea.addEventListener("pointerup",this.handlePointerUp),this.swipeArea.addEventListener("pointercancel",this.handlePointerCancel),this.swipeArea.addEventListener("pointerleave",this.handlePointerCancel)))}handleOverlayClick(t){t.target===this.overlay&&this.closeLightbox()}handleCloseClick(t){t.preventDefault(),this.closeLightbox()}handleNextClick(t){t.preventDefault(),this.step(1)}handlePrevClick(t){t.preventDefault(),this.step(-1)}handlePointerDown(t){!t.isPrimary||t.pointerType==="mouse"&&t.button!==0||!this.swipeArea||!this.imageEl||this.overlay?.classList.contains("hidden")||(this.swipeState={pointerId:t.pointerId,startX:t.clientX,startY:t.clientY,swiping:!1},this.swipeArea.style.cursor="grabbing",this.swipeArea.classList.add("is-touching"),t.stopPropagation())}handlePointerMove(t){if(!this.swipeState||t.pointerId!==this.swipeState.pointerId)return;const i=t.clientX-this.swipeState.startX,e=t.clientY-this.swipeState.startY;if(!this.swipeState.swiping){if(Math.abs(e)>this.maxVerticalDelta&&Math.abs(e)>Math.abs(i)){this.resetSwipeState();return}Math.abs(i)>12&&(this.swipeState.swiping=!0)}this.swipeState.swiping&&(t.preventDefault(),this.applySwipeTransform(i)),t.stopPropagation()}handlePointerUp(t){if(!this.swipeState||t.pointerId!==this.swipeState.pointerId)return;const i=t.clientX-this.swipeState.startX;this.swipeState.swiping&&Math.abs(i)>=this.swipeThreshold&&this.step(i>0?-1:1),this.resetSwipeState(),t.stopPropagation()}handlePointerCancel(t){!this.swipeState||t.pointerId!==this.swipeState.pointerId||(this.resetSwipeState(),t.stopPropagation())}applySwipeTransform(t,i={}){if(!this.imageEl)return;const{animate:e=!1}=i;if(e?this.imageEl.style.transition="transform 0.18s ease-out":this.imageEl.style.transition="transform 0s",t===0)this.imageEl.style.transform="translateX(0)";else{const o=Math.max(-160,Math.min(160,t));this.imageEl.style.transform=`translateX(${o}px)`}e?window.setTimeout(()=>{this.imageEl&&(this.imageEl.style.transition="")},200):t===0&&(this.imageEl.style.transition="")}resetSwipeState(){const t=!!this.swipeState?.swiping;this.swipeArea&&(this.swipeArea.style.cursor="",this.swipeArea.classList.remove("is-touching")),this.applySwipeTransform(0,{animate:t}),this.swipeState=null}handleKeyDown(t){this.overlay?.classList.contains("hidden")||(t.key==="Escape"?(t.preventDefault(),this.closeLightbox()):t.key==="ArrowRight"?(t.preventDefault(),this.step(1)):t.key==="ArrowLeft"&&(t.preventDefault(),this.step(-1)))}refreshNavVisibility(){if(!this.nextBtn||!this.prevBtn)return;const t=!this.items||this.items.length<2,i=e=>{t?(e.classList.add("sm:hidden"),e.setAttribute("aria-hidden","true"),e.setAttribute("tabindex","-1")):(e.classList.remove("sm:hidden"),e.removeAttribute("aria-hidden"),e.removeAttribute("tabindex"))};i(this.nextBtn),i(this.prevBtn)}renderTags(t){if(!this.tagsContainer||!this.tagsWrapper)return;this.tagsContainer.innerHTML="";const i=Array.isArray(t)?t.filter(r=>r&&r.slug):[];if(i.length===0){this.tagsWrapper.classList.add("hidden");return}this.tagsWrapper.classList.remove("hidden");const e=this.base||"/",o=e.endsWith("/")?e:`${e}/`;i.forEach(r=>{const s=document.createElement("a");s.href=`${o}tag/${r.slug}`,s.textContent=`#${r.label||r.code||r.slug}`,s.className="lightbox-tag",this.tagsContainer.appendChild(s)})}updateOverlayContent(){const t=this.items[this.activeIndex];if(!t)return;const i=t.preview||t.grid||t.thumb;if(this.imageEl){i?this.imageEl.src!==i&&(this.imageEl.src=i):this.imageEl.removeAttribute("src"),this.imageEl.alt=t.name||t.title||"Gallery image";const e=this.base||"/",r=`${e.endsWith("/")?e:`${e}/`}assets/img/unavailable.svg`;this.imageEl._fallbackHandlerAttached||(this.imageEl._fallbackHandlerAttached=!0,this.imageEl.addEventListener("error",function s(){this.dataset.fallbackApplied||(this.dataset.fallbackApplied="1",this.removeEventListener("error",s),this.src=r,this.alt="Not available",this.classList.add("is-fallback"))})),this.imageEl.style.transform="translateX(0)",this.imageEl.style.transition=""}this.nameEl&&(t.name?(this.nameEl.textContent=t.name,this.nameEl.classList.remove("hidden")):(this.nameEl.textContent="",this.nameEl.classList.add("hidden"))),this.authorEl&&(t.author?(this.authorEl.textContent=`by ${t.author}`,this.authorEl.classList.remove("hidden")):(this.authorEl.textContent="",this.authorEl.classList.add("hidden"))),this.descEl&&(t.desc?(this.descEl.textContent=t.desc,this.descEl.classList.remove("hidden")):(this.descEl.textContent="",this.descEl.classList.add("hidden"))),this.renderTags(t.tags)}openLightbox(t){!this.overlay||!this.items.length||(this.activeIndex=t,this.updateOverlayContent(),this.overlay.classList.remove("hidden"),this.overlay.setAttribute("aria-hidden","false"),this.previousOverflow=document.body.style.overflow,document.body.style.overflow="hidden",window.addEventListener("keydown",this.handleKeyDown),requestAnimationFrame(()=>{this.closeBtn?.focus()}))}closeLightbox(){if(!this.overlay||this.overlay.classList.contains("hidden"))return;this.overlay.classList.add("hidden"),this.overlay.setAttribute("aria-hidden","true"),document.body.style.overflow=this.previousOverflow,window.removeEventListener("keydown",this.handleKeyDown),this.triggers[this.activeIndex]?.focus({preventScroll:!0})}step(t){!this.items||this.items.length<2||(this.activeIndex=(this.activeIndex+t+this.items.length)%this.items.length,this.updateOverlayContent())}}const x=Array.from(document.querySelectorAll("[data-lightbox-root]"));x.forEach(v=>{v.dataset.lightboxItems&&v.dataset.lightboxItems.length>0&&new E(v)});(()=>{const v="cardgallery-layout-mode",t=new WeakSet,i=(s,l)=>{s.forEach(a=>{const n=a.dataset.mode===l;a.classList.toggle("is-active",n),a.setAttribute("aria-pressed",n?"true":"false")})},e=(s,l)=>l&&l.id===s&&document.body.contains(l)?l:document.getElementById(s)||null,o=s=>{if(!s||t.has(s))return;const l=s.dataset.target||"",a=s.dataset.default||"classic",n=Array.from(s.querySelectorAll("[data-mode]"));if(!l||n.length===0)return;const d=new Set(n.map(h=>h.dataset.mode));let c=e(l,null),u=null;const m=h=>{const p=d.has(h)?h:a;if(i(n,p),u=p,c=e(l,c),!!c){u=null,c.dataset.layoutMode!==p&&(c.dataset.layoutMode=p);try{localStorage.setItem(v,p)}catch{}}};let f=a;try{const h=localStorage.getItem(v);h&&d.has(h)&&(f=h)}catch{}if(n.forEach(h=>{h.addEventListener("click",p=>{p.preventDefault(),m(h.dataset.mode)})}),!c){const h=new MutationObserver(()=>{c=e(l,c),c&&(h.disconnect(),m(u||f))});h.observe(document.documentElement,{childList:!0,subtree:!0})}m(f),t.add(s)},r=()=>{document.querySelectorAll("[data-layout-toggle]").forEach(s=>o(s))};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r,{once:!0}):r(),document.addEventListener("astro:page-load",r),document.addEventListener("astro:after-swap",r)})();
