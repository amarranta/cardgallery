class b{constructor(t){this.root=t,this.gridEl=t.querySelector("[data-justified-grid]"),this.overlay=t.querySelector("[data-lightbox]"),this.imageEl=this.overlay?.querySelector("[data-lightbox-image]")||null,this.nameEl=this.overlay?.querySelector("[data-lightbox-name]")||null,this.descEl=this.overlay?.querySelector("[data-lightbox-desc]")||null,this.authorEl=this.overlay?.querySelector("[data-lightbox-author]")||null,this.tagsWrapper=this.overlay?.querySelector("[data-lightbox-tags-wrapper]")||null,this.tagsContainer=this.overlay?.querySelector("[data-lightbox-tags]")||null,this.closeBtn=this.overlay?.querySelector("[data-lightbox-close]")||null,this.nextBtn=this.overlay?.querySelector("[data-lightbox-next]")||null,this.prevBtn=this.overlay?.querySelector("[data-lightbox-prev]")||null,this.items=this.parseItems(t.dataset.lightboxItems),this.base=t.dataset.lightboxBase||"/",this.baseTargetHeight=Number(this.gridEl?.dataset.rowHeight)||400,this.gap=Number(this.gridEl?.dataset.rowGap)||12,this.swipeArea=this.overlay?.querySelector("[data-lightbox-swipe]")||null,this.swipeState=null,this.swipeThreshold=60,this.maxVerticalDelta=80,this.triggers=[],this.activeIndex=0,this.previousOverflow="",this.handleKeyDown=this.handleKeyDown.bind(this),this.handleOverlayClick=this.handleOverlayClick.bind(this),this.handleCloseClick=this.handleCloseClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handlePrevClick=this.handlePrevClick.bind(this),this.handlePointerDown=this.handlePointerDown.bind(this),this.handlePointerMove=this.handlePointerMove.bind(this),this.handlePointerUp=this.handlePointerUp.bind(this),this.handlePointerCancel=this.handlePointerCancel.bind(this),!(!this.gridEl||!this.items.length)&&(this.setupOverlayControls(),this.renderGrid(),typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(()=>{this.renderGrid()}),this.resizeObserver.observe(this.root)))}parseItems(t){if(!t)return[];try{const i=JSON.parse(decodeURIComponent(t));return Array.isArray(i)?i:[]}catch(i){return console.warn("Failed to parse justified gallery items",i),[]}}getAspect(t){const i=Number(t?.aspectRatio);if(Number.isFinite(i)&&i>0)return i;const e=Number(t?.width),r=Number(t?.height);return Number.isFinite(e)&&Number.isFinite(r)&&r>0?e/r:1.5}getResponsiveTargetHeight(t){const i=typeof window<"u"?window.innerWidth:t,e=this.baseTargetHeight||400;if(!Number.isFinite(e)||e<=0)return 400;const r=Math.max(160,Math.min(e,220)),n=Math.max(200,Math.min(e,280)),s=Math.max(240,Math.min(e,340));return i<=480||t<=480?r:i<=768?n:i<=1024?s:e}renderGrid(){if(!this.gridEl)return;const t=this.gridEl.clientWidth||this.gridEl.offsetWidth;if(!t){requestAnimationFrame(()=>this.renderGrid());return}this.gridEl.style.setProperty("--row-gap",`${this.gap}px`),this.gridEl.innerHTML="",this.triggers=[];const i=this.items,e=this.getResponsiveTargetHeight(t),r=1.35,n=.7;let s=[],l=0;const a=h=>{if(!s.length)return;let p=(t-this.gap*(s.length-1))/l;const m=Math.max(e*n,Math.min(e*r,p)),d=h?e:m,g=document.createElement("div");g.className="justified-row",g.style.height=`${d}px`,h&&g.classList.add("justified-row--last"),s.forEach(f=>{const c=this.createTrigger(f.item,f.index);h?(c.style.flex="0 0 auto",c.style.width=`${d*f.aspect}px`,c.style.height=`${d}px`):(c.style.flex=`${f.aspect} 1 0`,c.style.height=`${d}px`),g.appendChild(c)}),this.gridEl.appendChild(g),s=[],l=0};i.forEach((h,o)=>{const p=this.getAspect(h);s.push({item:h,aspect:p,index:o}),l+=p,l*e+this.gap*(s.length-1)>=t&&a(!1)}),s.length&&a(!0),this.refreshNavVisibility()}createTrigger(t,i){const e=document.createElement("button");e.type="button",e.dataset.lightboxTrigger="",e.dataset.index=String(i),e.className="justified-item";const r=t.name||t.title,n=r?`Open ${r} in lightbox`:"Open image in lightbox";e.setAttribute("aria-label",n);const s=document.createElement("img");if(s.src=t.grid||t.preview||t.thumb,s.alt=t.name||t.title||"Gallery image",s.loading="lazy",s.decoding="async",function(a,h){const o=h||"/",m=`${o.endsWith("/")?o:`${o}/`}assets/img/unavailable.svg`;a.addEventListener("error",function d(){a.dataset.fallbackApplied||(a.dataset.fallbackApplied="1",a.removeEventListener("error",d),a.src=m,a.alt="Not available",a.classList.add("is-fallback"))})}(s,this.base),e.appendChild(s),t.name||t.desc){const l=document.createElement("div");if(l.className="justified-item__overlay",t.name){const a=document.createElement("strong");a.className="justified-item__title",a.textContent=t.name,l.appendChild(a)}if(t.desc){const a=document.createElement("p");a.className="justified-item__desc",a.textContent=t.desc,l.appendChild(a)}e.appendChild(l)}return e.addEventListener("click",l=>{l.preventDefault(),this.openLightbox(i)}),this.triggers[i]=e,e}setupOverlayControls(){this.overlay&&(this.overlay.addEventListener("click",this.handleOverlayClick),this.closeBtn?.addEventListener("click",this.handleCloseClick),this.nextBtn?.addEventListener("click",this.handleNextClick),this.prevBtn?.addEventListener("click",this.handlePrevClick),this.swipeArea&&(this.swipeArea.addEventListener("pointerdown",this.handlePointerDown),this.swipeArea.addEventListener("pointermove",this.handlePointerMove),this.swipeArea.addEventListener("pointerup",this.handlePointerUp),this.swipeArea.addEventListener("pointercancel",this.handlePointerCancel),this.swipeArea.addEventListener("pointerleave",this.handlePointerCancel)))}handleOverlayClick(t){t.target===this.overlay&&this.closeLightbox()}handleCloseClick(t){t.preventDefault(),this.closeLightbox()}handleNextClick(t){t.preventDefault(),this.step(1)}handlePrevClick(t){t.preventDefault(),this.step(-1)}handlePointerDown(t){!t.isPrimary||t.pointerType==="mouse"&&t.button!==0||!this.swipeArea||!this.imageEl||this.overlay?.classList.contains("hidden")||(this.swipeState={pointerId:t.pointerId,startX:t.clientX,startY:t.clientY,swiping:!1},this.swipeArea.style.cursor="grabbing",this.swipeArea.classList.add("is-touching"),t.stopPropagation())}handlePointerMove(t){if(!this.swipeState||t.pointerId!==this.swipeState.pointerId)return;const i=t.clientX-this.swipeState.startX,e=t.clientY-this.swipeState.startY;if(!this.swipeState.swiping){if(Math.abs(e)>this.maxVerticalDelta&&Math.abs(e)>Math.abs(i)){this.resetSwipeState();return}Math.abs(i)>12&&(this.swipeState.swiping=!0)}this.swipeState.swiping&&(t.preventDefault(),this.applySwipeTransform(i)),t.stopPropagation()}handlePointerUp(t){if(!this.swipeState||t.pointerId!==this.swipeState.pointerId)return;const i=t.clientX-this.swipeState.startX;this.swipeState.swiping&&Math.abs(i)>=this.swipeThreshold&&this.step(i>0?-1:1),this.resetSwipeState(),t.stopPropagation()}handlePointerCancel(t){!this.swipeState||t.pointerId!==this.swipeState.pointerId||(this.resetSwipeState(),t.stopPropagation())}applySwipeTransform(t,i={}){if(!this.imageEl)return;const{animate:e=!1}=i;if(e?this.imageEl.style.transition="transform 0.18s ease-out":this.imageEl.style.transition="transform 0s",t===0)this.imageEl.style.transform="translateX(0)";else{const r=Math.max(-160,Math.min(160,t));this.imageEl.style.transform=`translateX(${r}px)`}e?window.setTimeout(()=>{this.imageEl&&(this.imageEl.style.transition="")},200):t===0&&(this.imageEl.style.transition="")}resetSwipeState(){const t=!!this.swipeState?.swiping;this.swipeArea&&(this.swipeArea.style.cursor="",this.swipeArea.classList.remove("is-touching")),this.applySwipeTransform(0,{animate:t}),this.swipeState=null}handleKeyDown(t){this.overlay?.classList.contains("hidden")||(t.key==="Escape"?(t.preventDefault(),this.closeLightbox()):t.key==="ArrowRight"?(t.preventDefault(),this.step(1)):t.key==="ArrowLeft"&&(t.preventDefault(),this.step(-1)))}refreshNavVisibility(){if(!this.nextBtn||!this.prevBtn)return;const t=!this.items||this.items.length<2,i=e=>{t?(e.classList.add("sm:hidden"),e.setAttribute("aria-hidden","true"),e.setAttribute("tabindex","-1")):(e.classList.remove("sm:hidden"),e.removeAttribute("aria-hidden"),e.removeAttribute("tabindex"))};i(this.nextBtn),i(this.prevBtn)}renderTags(t){if(!this.tagsContainer||!this.tagsWrapper)return;this.tagsContainer.innerHTML="";const i=Array.isArray(t)?t.filter(n=>n&&n.slug):[];if(i.length===0){this.tagsWrapper.classList.add("hidden");return}this.tagsWrapper.classList.remove("hidden");const e=this.base||"/",r=e.endsWith("/")?e:`${e}/`;i.forEach(n=>{const s=document.createElement("a");s.href=`${r}tag/${n.slug}`,s.textContent=`#${n.label||n.code||n.slug}`,s.className="lightbox-tag",this.tagsContainer.appendChild(s)})}updateOverlayContent(){const t=this.items[this.activeIndex];if(!t)return;const i=t.preview||t.grid||t.thumb;if(this.imageEl){i?this.imageEl.src!==i&&(this.imageEl.src=i):this.imageEl.removeAttribute("src"),this.imageEl.alt=t.name||t.title||"Gallery image";const e=this.base||"/",n=`${e.endsWith("/")?e:`${e}/`}assets/img/unavailable.svg`;this.imageEl._fallbackHandlerAttached||(this.imageEl._fallbackHandlerAttached=!0,this.imageEl.addEventListener("error",function s(){this.dataset.fallbackApplied||(this.dataset.fallbackApplied="1",this.removeEventListener("error",s),this.src=n,this.alt="Not available",this.classList.add("is-fallback"))})),this.imageEl.style.transform="translateX(0)",this.imageEl.style.transition=""}this.nameEl&&(t.name?(this.nameEl.textContent=t.name,this.nameEl.classList.remove("hidden")):(this.nameEl.textContent="",this.nameEl.classList.add("hidden"))),this.authorEl&&(t.author?(this.authorEl.textContent=`by ${t.author}`,this.authorEl.classList.remove("hidden")):(this.authorEl.textContent="",this.authorEl.classList.add("hidden"))),this.descEl&&(t.desc?(this.descEl.textContent=t.desc,this.descEl.classList.remove("hidden")):(this.descEl.textContent="",this.descEl.classList.add("hidden"))),this.renderTags(t.tags)}openLightbox(t){!this.overlay||!this.items.length||(this.activeIndex=t,this.updateOverlayContent(),this.overlay.classList.remove("hidden"),this.overlay.setAttribute("aria-hidden","false"),this.previousOverflow=document.body.style.overflow,document.body.style.overflow="hidden",window.addEventListener("keydown",this.handleKeyDown),requestAnimationFrame(()=>{this.closeBtn?.focus()}))}closeLightbox(){if(!this.overlay||this.overlay.classList.contains("hidden"))return;this.overlay.classList.add("hidden"),this.overlay.setAttribute("aria-hidden","true"),document.body.style.overflow=this.previousOverflow,window.removeEventListener("keydown",this.handleKeyDown),this.triggers[this.activeIndex]?.focus({preventScroll:!0})}step(t){!this.items||this.items.length<2||(this.activeIndex=(this.activeIndex+t+this.items.length)%this.items.length,this.updateOverlayContent())}}const v=Array.from(document.querySelectorAll("[data-lightbox-root]"));v.forEach(u=>{u.dataset.lightboxItems&&u.dataset.lightboxItems.length>0&&new b(u)});
