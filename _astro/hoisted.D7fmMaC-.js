class v{constructor(e){this.root=e,this.gridEl=e.querySelector("[data-justified-grid]"),this.overlay=e.querySelector("[data-lightbox]"),this.imageEl=this.overlay?.querySelector("[data-lightbox-image]")||null,this.nameEl=this.overlay?.querySelector("[data-lightbox-name]")||null,this.descEl=this.overlay?.querySelector("[data-lightbox-desc]")||null,this.tagsWrapper=this.overlay?.querySelector("[data-lightbox-tags-wrapper]")||null,this.tagsContainer=this.overlay?.querySelector("[data-lightbox-tags]")||null,this.closeBtn=this.overlay?.querySelector("[data-lightbox-close]")||null,this.nextBtn=this.overlay?.querySelector("[data-lightbox-next]")||null,this.prevBtn=this.overlay?.querySelector("[data-lightbox-prev]")||null,this.items=this.parseItems(e.dataset.lightboxItems),this.base=e.dataset.lightboxBase||"/",this.targetHeight=Number(this.gridEl?.dataset.rowHeight)||400,this.gap=Number(this.gridEl?.dataset.rowGap)||12,this.triggers=[],this.activeIndex=0,this.previousOverflow="",this.handleKeyDown=this.handleKeyDown.bind(this),this.handleOverlayClick=this.handleOverlayClick.bind(this),this.handleCloseClick=this.handleCloseClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handlePrevClick=this.handlePrevClick.bind(this),!(!this.gridEl||!this.items.length)&&(this.setupOverlayControls(),this.renderGrid(),typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(()=>{this.renderGrid()}),this.resizeObserver.observe(this.root)))}parseItems(e){if(!e)return[];try{const t=JSON.parse(decodeURIComponent(e));return Array.isArray(t)?t:[]}catch(t){return console.warn("Failed to parse justified gallery items",t),[]}}getAspect(e){const t=Number(e?.aspectRatio);if(Number.isFinite(t)&&t>0)return t;const i=Number(e?.width),l=Number(e?.height);return Number.isFinite(i)&&Number.isFinite(l)&&l>0?i/l:1.5}renderGrid(){if(!this.gridEl)return;const e=this.gridEl.clientWidth||this.gridEl.offsetWidth;if(!e){requestAnimationFrame(()=>this.renderGrid());return}this.gridEl.style.setProperty("--row-gap",`${this.gap}px`),this.gridEl.innerHTML="",this.triggers=[];const t=this.items,i=1.35,l=.7;let s=[],r=0;const n=a=>{if(!s.length)return;let c=(e-this.gap*(s.length-1))/r;const p=Math.max(this.targetHeight*l,Math.min(this.targetHeight*i,c)),g=a?this.targetHeight:p,d=document.createElement("div");d.className="justified-row",d.style.height=`${g}px`,a&&d.classList.add("justified-row--last"),s.forEach(u=>{const h=this.createTrigger(u.item,u.index);a?(h.style.flex="0 0 auto",h.style.width=`${g*u.aspect}px`,h.style.height=`${g}px`):(h.style.flex=`${u.aspect} 1 0`,h.style.height=`${g}px`),d.appendChild(h)}),this.gridEl.appendChild(d),s=[],r=0};t.forEach((a,m)=>{const c=this.getAspect(a);s.push({item:a,aspect:c,index:m}),r+=c,r*this.targetHeight+this.gap*(s.length-1)>=e&&n(!1)}),s.length&&n(!0),this.refreshNavVisibility()}createTrigger(e,t){const i=document.createElement("button");i.type="button",i.dataset.lightboxTrigger="",i.dataset.index=String(t),i.className="justified-item";const l=e.name||e.title,s=l?`Open ${l} in lightbox`:"Open image in lightbox";i.setAttribute("aria-label",s);const r=document.createElement("img");if(r.src=e.grid||e.preview||e.thumb,r.alt=e.name||e.title||"Gallery image",r.loading="lazy",r.decoding="async",i.appendChild(r),e.name||e.desc){const n=document.createElement("div");if(n.className="justified-item__overlay",e.name){const a=document.createElement("strong");a.className="justified-item__title",a.textContent=e.name,n.appendChild(a)}if(e.desc){const a=document.createElement("p");a.className="justified-item__desc",a.textContent=e.desc,n.appendChild(a)}i.appendChild(n)}return i.addEventListener("click",n=>{n.preventDefault(),this.openLightbox(t)}),this.triggers[t]=i,i}setupOverlayControls(){this.overlay&&(this.overlay.addEventListener("click",this.handleOverlayClick),this.closeBtn?.addEventListener("click",this.handleCloseClick),this.nextBtn?.addEventListener("click",this.handleNextClick),this.prevBtn?.addEventListener("click",this.handlePrevClick))}handleOverlayClick(e){e.target===this.overlay&&this.closeLightbox()}handleCloseClick(e){e.preventDefault(),this.closeLightbox()}handleNextClick(e){e.preventDefault(),this.step(1)}handlePrevClick(e){e.preventDefault(),this.step(-1)}handleKeyDown(e){this.overlay?.classList.contains("hidden")||(e.key==="Escape"?(e.preventDefault(),this.closeLightbox()):e.key==="ArrowRight"?(e.preventDefault(),this.step(1)):e.key==="ArrowLeft"&&(e.preventDefault(),this.step(-1)))}refreshNavVisibility(){!this.nextBtn||!this.prevBtn||(!this.items||this.items.length<2?(this.nextBtn.classList.add("hidden"),this.prevBtn.classList.add("hidden")):(this.nextBtn.classList.remove("hidden"),this.prevBtn.classList.remove("hidden")))}renderTags(e){if(!this.tagsContainer||!this.tagsWrapper)return;this.tagsContainer.innerHTML="";const t=Array.isArray(e)?e.filter(s=>s&&s.slug):[];if(t.length===0){this.tagsWrapper.classList.add("hidden");return}this.tagsWrapper.classList.remove("hidden");const i=this.base||"/",l=i.endsWith("/")?i:`${i}/`;t.forEach(s=>{const r=document.createElement("a");r.href=`${l}tag/${s.slug}`,r.textContent=`#${s.label||s.code||s.slug}`,r.className="lightbox-tag",this.tagsContainer.appendChild(r)})}updateOverlayContent(){const e=this.items[this.activeIndex];if(!e)return;const t=e.preview||e.grid||e.thumb;this.imageEl&&(t?this.imageEl.src!==t&&(this.imageEl.src=t):this.imageEl.removeAttribute("src"),this.imageEl.alt=e.name||e.title||"Gallery image"),this.nameEl&&(e.name?(this.nameEl.textContent=e.name,this.nameEl.classList.remove("hidden")):(this.nameEl.textContent="",this.nameEl.classList.add("hidden"))),this.descEl&&(e.desc?(this.descEl.textContent=e.desc,this.descEl.classList.remove("hidden")):(this.descEl.textContent="",this.descEl.classList.add("hidden"))),this.renderTags(e.tags)}openLightbox(e){!this.overlay||!this.items.length||(this.activeIndex=e,this.updateOverlayContent(),this.overlay.classList.remove("hidden"),this.overlay.setAttribute("aria-hidden","false"),this.previousOverflow=document.body.style.overflow,document.body.style.overflow="hidden",window.addEventListener("keydown",this.handleKeyDown),requestAnimationFrame(()=>{this.closeBtn?.focus()}))}closeLightbox(){if(!this.overlay||this.overlay.classList.contains("hidden"))return;this.overlay.classList.add("hidden"),this.overlay.setAttribute("aria-hidden","true"),document.body.style.overflow=this.previousOverflow,window.removeEventListener("keydown",this.handleKeyDown),this.triggers[this.activeIndex]?.focus({preventScroll:!0})}step(e){!this.items||this.items.length<2||(this.activeIndex=(this.activeIndex+e+this.items.length)%this.items.length,this.updateOverlayContent())}}const f=Array.from(document.querySelectorAll("[data-lightbox-root]"));f.forEach(o=>{o.dataset.lightboxItems&&o.dataset.lightboxItems.length>0&&new v(o)});
