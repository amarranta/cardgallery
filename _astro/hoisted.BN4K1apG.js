class f{constructor(e){this.root=e,this.gridEl=e.querySelector("[data-justified-grid]"),this.overlay=e.querySelector("[data-lightbox]"),this.imageEl=this.overlay?.querySelector("[data-lightbox-image]")||null,this.nameEl=this.overlay?.querySelector("[data-lightbox-name]")||null,this.descEl=this.overlay?.querySelector("[data-lightbox-desc]")||null,this.authorEl=this.overlay?.querySelector("[data-lightbox-author]")||null,this.tagsWrapper=this.overlay?.querySelector("[data-lightbox-tags-wrapper]")||null,this.tagsContainer=this.overlay?.querySelector("[data-lightbox-tags]")||null,this.closeBtn=this.overlay?.querySelector("[data-lightbox-close]")||null,this.nextBtn=this.overlay?.querySelector("[data-lightbox-next]")||null,this.prevBtn=this.overlay?.querySelector("[data-lightbox-prev]")||null,this.items=this.parseItems(e.dataset.lightboxItems),this.base=e.dataset.lightboxBase||"/",this.targetHeight=Number(this.gridEl?.dataset.rowHeight)||400,this.gap=Number(this.gridEl?.dataset.rowGap)||12,this.triggers=[],this.activeIndex=0,this.previousOverflow="",this.handleKeyDown=this.handleKeyDown.bind(this),this.handleOverlayClick=this.handleOverlayClick.bind(this),this.handleCloseClick=this.handleCloseClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handlePrevClick=this.handlePrevClick.bind(this),!(!this.gridEl||!this.items.length)&&(this.setupOverlayControls(),this.renderGrid(),typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(()=>{this.renderGrid()}),this.resizeObserver.observe(this.root)))}parseItems(e){if(!e)return[];try{const s=JSON.parse(decodeURIComponent(e));return Array.isArray(s)?s:[]}catch(s){return console.warn("Failed to parse justified gallery items",s),[]}}getAspect(e){const s=Number(e?.aspectRatio);if(Number.isFinite(s)&&s>0)return s;const t=Number(e?.width),l=Number(e?.height);return Number.isFinite(t)&&Number.isFinite(l)&&l>0?t/l:1.5}renderGrid(){if(!this.gridEl)return;const e=this.gridEl.clientWidth||this.gridEl.offsetWidth;if(!e){requestAnimationFrame(()=>this.renderGrid());return}this.gridEl.style.setProperty("--row-gap",`${this.gap}px`),this.gridEl.innerHTML="",this.triggers=[];const s=this.items,t=1.35,l=.7;let a=[],r=0;const n=i=>{if(!a.length)return;let h=(e-this.gap*(a.length-1))/r;const p=Math.max(this.targetHeight*l,Math.min(this.targetHeight*t,h)),o=i?this.targetHeight:p,d=document.createElement("div");d.className="justified-row",d.style.height=`${o}px`,i&&d.classList.add("justified-row--last"),a.forEach(v=>{const c=this.createTrigger(v.item,v.index);i?(c.style.flex="0 0 auto",c.style.width=`${o*v.aspect}px`,c.style.height=`${o}px`):(c.style.flex=`${v.aspect} 1 0`,c.style.height=`${o}px`),d.appendChild(c)}),this.gridEl.appendChild(d),a=[],r=0};s.forEach((i,u)=>{const h=this.getAspect(i);a.push({item:i,aspect:h,index:u}),r+=h,r*this.targetHeight+this.gap*(a.length-1)>=e&&n(!1)}),a.length&&n(!0),this.refreshNavVisibility()}createTrigger(e,s){const t=document.createElement("button");t.type="button",t.dataset.lightboxTrigger="",t.dataset.index=String(s),t.className="justified-item";const l=e.name||e.title,a=l?`Open ${l} in lightbox`:"Open image in lightbox";t.setAttribute("aria-label",a);const r=document.createElement("img");if(r.src=e.grid||e.preview||e.thumb,r.alt=e.name||e.title||"Gallery image",r.loading="lazy",r.decoding="async",function(i,u){const h=u||"/",o=`${h.endsWith("/")?h:`${h}/`}assets/img/unavailable.svg`;i.addEventListener("error",function d(){i.dataset.fallbackApplied||(i.dataset.fallbackApplied="1",i.removeEventListener("error",d),i.src=o,i.alt="Not available",i.classList.add("is-fallback"))})}(r,this.base),t.appendChild(r),e.name||e.desc){const n=document.createElement("div");if(n.className="justified-item__overlay",e.name){const i=document.createElement("strong");i.className="justified-item__title",i.textContent=e.name,n.appendChild(i)}if(e.desc){const i=document.createElement("p");i.className="justified-item__desc",i.textContent=e.desc,n.appendChild(i)}t.appendChild(n)}return t.addEventListener("click",n=>{n.preventDefault(),this.openLightbox(s)}),this.triggers[s]=t,t}setupOverlayControls(){this.overlay&&(this.overlay.addEventListener("click",this.handleOverlayClick),this.closeBtn?.addEventListener("click",this.handleCloseClick),this.nextBtn?.addEventListener("click",this.handleNextClick),this.prevBtn?.addEventListener("click",this.handlePrevClick))}handleOverlayClick(e){e.target===this.overlay&&this.closeLightbox()}handleCloseClick(e){e.preventDefault(),this.closeLightbox()}handleNextClick(e){e.preventDefault(),this.step(1)}handlePrevClick(e){e.preventDefault(),this.step(-1)}handleKeyDown(e){this.overlay?.classList.contains("hidden")||(e.key==="Escape"?(e.preventDefault(),this.closeLightbox()):e.key==="ArrowRight"?(e.preventDefault(),this.step(1)):e.key==="ArrowLeft"&&(e.preventDefault(),this.step(-1)))}refreshNavVisibility(){!this.nextBtn||!this.prevBtn||(!this.items||this.items.length<2?(this.nextBtn.classList.add("hidden"),this.prevBtn.classList.add("hidden")):(this.nextBtn.classList.remove("hidden"),this.prevBtn.classList.remove("hidden")))}renderTags(e){if(!this.tagsContainer||!this.tagsWrapper)return;this.tagsContainer.innerHTML="";const s=Array.isArray(e)?e.filter(a=>a&&a.slug):[];if(s.length===0){this.tagsWrapper.classList.add("hidden");return}this.tagsWrapper.classList.remove("hidden");const t=this.base||"/",l=t.endsWith("/")?t:`${t}/`;s.forEach(a=>{const r=document.createElement("a");r.href=`${l}tag/${a.slug}`,r.textContent=`#${a.label||a.code||a.slug}`,r.className="lightbox-tag",this.tagsContainer.appendChild(r)})}updateOverlayContent(){const e=this.items[this.activeIndex];if(!e)return;const s=e.preview||e.grid||e.thumb;if(this.imageEl){s?this.imageEl.src!==s&&(this.imageEl.src=s):this.imageEl.removeAttribute("src"),this.imageEl.alt=e.name||e.title||"Gallery image";const t=this.base||"/",a=`${t.endsWith("/")?t:`${t}/`}assets/img/unavailable.svg`;this.imageEl._fallbackHandlerAttached||(this.imageEl._fallbackHandlerAttached=!0,this.imageEl.addEventListener("error",function r(){this.dataset.fallbackApplied||(this.dataset.fallbackApplied="1",this.removeEventListener("error",r),this.src=a,this.alt="Not available",this.classList.add("is-fallback"))}))}this.nameEl&&(e.name?(this.nameEl.textContent=e.name,this.nameEl.classList.remove("hidden")):(this.nameEl.textContent="",this.nameEl.classList.add("hidden"))),this.authorEl&&(e.author?(this.authorEl.textContent=`by ${e.author}`,this.authorEl.classList.remove("hidden")):(this.authorEl.textContent="",this.authorEl.classList.add("hidden"))),this.descEl&&(e.desc?(this.descEl.textContent=e.desc,this.descEl.classList.remove("hidden")):(this.descEl.textContent="",this.descEl.classList.add("hidden"))),this.renderTags(e.tags)}openLightbox(e){!this.overlay||!this.items.length||(this.activeIndex=e,this.updateOverlayContent(),this.overlay.classList.remove("hidden"),this.overlay.setAttribute("aria-hidden","false"),this.previousOverflow=document.body.style.overflow,document.body.style.overflow="hidden",window.addEventListener("keydown",this.handleKeyDown),requestAnimationFrame(()=>{this.closeBtn?.focus()}))}closeLightbox(){if(!this.overlay||this.overlay.classList.contains("hidden"))return;this.overlay.classList.add("hidden"),this.overlay.setAttribute("aria-hidden","true"),document.body.style.overflow=this.previousOverflow,window.removeEventListener("keydown",this.handleKeyDown),this.triggers[this.activeIndex]?.focus({preventScroll:!0})}step(e){!this.items||this.items.length<2||(this.activeIndex=(this.activeIndex+e+this.items.length)%this.items.length,this.updateOverlayContent())}}const m=Array.from(document.querySelectorAll("[data-lightbox-root]"));m.forEach(g=>{g.dataset.lightboxItems&&g.dataset.lightboxItems.length>0&&new f(g)});
